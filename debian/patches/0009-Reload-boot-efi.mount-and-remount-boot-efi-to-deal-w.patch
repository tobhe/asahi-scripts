From: Tobias Heider <me@tobhe.de>
Date: Fri, 31 Mar 2023 02:29:08 +0200
Subject: Reload boot-efi.mount and remount /boot/efi to deal with systemd
 shenanigans. Very funny.

---
 first-boot  | 2 ++
 update-grub | 3 +++
 2 files changed, 5 insertions(+)

diff --git a/first-boot b/first-boot
index 52fc8a4..f7e1480 100755
--- a/first-boot
+++ b/first-boot
@@ -36,6 +36,8 @@ if [ ! -z "$root_uuid" ] && [ ! -z "$efi_uuid" ]; then
 $root_uuid / ext4 rw,relatime,x-systemd.growfs 0 1
 $efi_uuid /boot/efi vfat rw,relatime,fmask=0022,dmask=0022,codepage=437,iocharset=iso8859-1,shortname=mixed,errors=remount-ro    0 2
 EOF
+    # XXX: reload for boot-efi.mount
+    systemctl daemon-reload
     echo
 fi
 
diff --git a/update-grub b/update-grub
index b94323d..e7acaad 100755
--- a/update-grub
+++ b/update-grub
@@ -42,6 +42,9 @@ grub-mkimage \
     --compression auto \
     $MODULES
 
+# XXX: Make sure ESP is mounted. systemd seems to think it is funny to unmount it
+# without a reason
+mount "$EFI_PART" > /dev/null 2>&1 || true
 cp "$GRUB_DIR"/arm64-efi/core.efi "$TARGET"
 
 grub-mkconfig -o "$CONFIG"
