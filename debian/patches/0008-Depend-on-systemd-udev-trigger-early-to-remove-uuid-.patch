From: Tobias Heider <me@tobhe.de>
Date: Fri, 31 Mar 2023 02:24:45 +0200
Subject: Depend on systemd-udev-trigger-early to remove uuid lookup hack.

---
 first-boot                 | 7 -------
 systemd/first-boot.service | 1 +
 2 files changed, 1 insertion(+), 7 deletions(-)

diff --git a/first-boot b/first-boot
index d1d0305..52fc8a4 100755
--- a/first-boot
+++ b/first-boot
@@ -39,11 +39,4 @@ EOF
     echo
 fi
 
-# XXX: grub-probe will look for the old UUID, this will keep it happy.
-#      sleep 1 is needed to make sure the new dev exists.
-if [ ! -z "$root_uuid" ]; then
-    sleep 1
-    ln -s "/dev/disk/by-uuid/$(echo "$root_uuid" | cut -d "=" -f2)" "/dev/disk/by-uuid/$root_uuid_old"
-fi
-
 update-grub
diff --git a/systemd/first-boot.service b/systemd/first-boot.service
index 9ae9080..9789948 100644
--- a/systemd/first-boot.service
+++ b/systemd/first-boot.service
@@ -4,6 +4,7 @@
 Description=Sets up system on first boot
 Before=sshd.service first-boot-complete.target
 Wants=first-boot-complete.target
+After=systemd-udev-trigger-early.service
 ConditionPathIsReadWrite=/etc
 ConditionFirstBoot=yes
 
